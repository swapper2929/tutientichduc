name: Build Ubuntu Lite Boot.img for RN7 Pro

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ROOTFS_PARTITION: "/dev/mmcblk0p10" # placeholder
      BOOTIMG_BASE: "0x10000000"           # từ bootimg.cfg gốc
      BOOTIMG_PAGESIZE: "4096"             # từ bootimg.cfg gốc
      CMDLINE: "console=ttyMSM0 root=/dev/mmcblk0p10 rw"

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential aarch64-linux-gnu cpio gzip wget unzip

    - name: Download Ubuntu Base ARM64
      run: |
        mkdir -p rootfs
        wget -q https://cdimage.ubuntu.com/ubuntu-base/releases/24.04/release/ubuntu-base-24.04-base-arm64.tar.gz
        tar -xzf ubuntu-base-24.04-base-arm64.tar.gz -C rootfs
        rm ubuntu-base-24.04-base-arm64.tar.gz

    - name: Create minimal initramfs
      run: |
        mkdir -p initramfs/{bin,dev,proc,sys}
        cat <<'EOF' > initramfs/init
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
echo "Booting Ubuntu ARM64 Lite..."
mount $ROOTFS_PARTITION /newroot
exec switch_root /newroot /sbin/init
EOF
        chmod +x initramfs/init

    - name: Package initramfs
      run: |
        cd initramfs
        find . | cpio -H newc -o | gzip > ../initramfs.img
        cd ..

    - name: Download kernel (replace with your kernel repo/file)
      run: |
        wget -q https://github.com/LineageOS/android_kernel_xiaomi_sm6150/raw/lineage-20.0/arch/arm64/boot/Image.gz-dtb -O Image.gz-dtb

    - name: Build boot.img
      run: |
        mkbootimg \
          --kernel Image.gz-dtb \
          --ramdisk initramfs.img \
          --cmdline "$CMDLINE" \
          --base $BOOTIMG_BASE \
          --pagesize $BOOTIMG_PAGESIZE \
          -o boot-new.img

    - name: Upload boot.img as artifact
      uses: actions/upload-artifact@v3
      with:
        name: boot-new.img
        path: boot-new.img
